<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="213b23e8-f61d-476f-8127-4bd0d3a65691">
    <title>Junction | Demo</title>
     
    <!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	
	<!-- MetisMenu CSS -->
    <link href="css/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    
    <link href="css/bootstrap-slider.css" rel="stylesheet" type="text/css">
	
	<!-- Optional theme -->
	<link rel="stylesheet" href="css/jquery.growl.css">
    <link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css">
	<style>
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
		#map {
			height: 700px;
			width: 700px;
		}
		#floating-panel {
			position: absolute;
			top: 10px;
			left: 25%;
			z-index: 5;
			background-color: #fff;
			padding: 5px;
			border: 1px solid #999;
			text-align: center;
			font-family: 'Roboto','sans-serif';
			line-height: 30px;
			padding-left: 10px;
		}
		
		#floating-panel {
			background-color: #fff;
			border: 1px solid #999;
			left: 25%;
			padding: 5px;
			position: absolute;
			top: 10px;
			z-index: 5;
		}
	</style>
	
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body >
  	
  	<div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="javascript:void(0)">Junction</a>
			</div>
			<!-- /.navbar-header -->

			<ul class="nav navbar-top-links navbar-right">
				
			</ul>
			<!-- /.navbar-top-links -->
            <div class="navbar-default sidebar" role="navigation">
				<div class="sidebar-nav navbar-collapse">
					<ul class="nav lines" id="side-menu">
					</ul>
				</div>
				<!-- /.sidebar-collapse -->
			</div>
			<!-- /.navbar-static-side -->
        </nav>

        <!-- Page Content -->
        <div id="page-wrapper">
        	<div class="container-fluid">
				<div class="row">
					<div class="col-md-8">
						<div id="map"></div>
					</div>
					<div class="col-md-4">
						<div class="block">
							<h2 class="line-title"></h2>
						</div>
						<div class="block line-control" >
							<a class="btn btn-primary" id="btn-show-complete" href="javascript:void(0)" role="button">Show complete route</a>
							<a class="btn btn-primary" id="btn-hide-complete" href="javascript:void(0)" role="button">Hide complete route</a>
						</div>
						<div class="block">
							<h3 class="item-title"></h2>
						</div>

						<div class="block station-control" >
							People : <span id="station-count"></span>
							<a class="btn btn-primary" id="station-less" href="javascript:void(0)">-2 people</a> - <a class="btn btn-primary" id="station-0" href="javascript:void(0)">0 people</a> - <a class="btn btn-primary" id="station-more" href="javascript:void(0)">+2 people</a>
							
						</div>
						<div class="block bus-control" >
							<input id="bus-load" type="text" data-slider-min="0" data-slider-max="70" data-slider-step="1" data-slider-value="[20, 50]"/>

						</div>
					</div>
				</div>
			</div>
            <!-- /.container-fluid -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->
    
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    
    <!-- Metis Menu Plugin JavaScript -->
    <script src="js/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/sb-admin-2.js"></script>
    
	<script src="js/jquery.growl.js" ></script>
	<script src="js/bootstrap-slider.js" ></script>
	<script>
		var map;
		
		var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		var directionsService;
		
		var currentStation = null;
		var currentBus = null;

		var stationMarkers = [];
		var busMarkers = [];
		var routeDirections = [];
		var completeRoute = [];

		function initMap() {
			directionsService = new google.maps.DirectionsService();
			
			var helsinki = {lat: 60.167469, lng: 24.961435}; //lat: 60.167469, lng: 24.961435
			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 13,
				center: helsinki
			});
			{#marker = new google.maps.Marker({
				position: helsinki,
				map: map
			}); #}
			
			//parseLines(lines);
			$.get( "http://junction.westeurope.cloudapp.azure.com/api/line/?format=json", function( data ) {
				//$( ".result" ).html( data );
				//alert( "Load was performed." );
				console.log("init : ****************************");
				console.log(data);
				parseLines(data);
			});
		}
		
		function print() {
			var seconds = 0;
			for(i=0;i<routeDirections.length;i++) {
				console.log(i);
				var k = routeDirections[i];
				var routes = k.directions.routes;
				for (j=0;j<routes.length;j++) {
					var route = routes[j];
					var legs = route.legs;
					for(k=0;k<legs.length;k++) {
						var leg = legs[k];
						seconds += leg.duration.value;
					}
				}
			}
			return seconds;
		}
		
		function clearStations() {
			for(i=0;i<stationMarkers.length;i++) {
				stationMarkers[i].setMap(null);
			}
			stationMarkers = [];
		}
		function clearDirections() {
			for(i=0;i<routeDirections.length;i++) {
				routeDirections[i].setMap(null);
			}
			routeDirections = [];
		}
		function clearBuses() {
			for(i=0;i<busMarkers.length;i++) {
				busMarkers[i].setMap(null);
			}
			busMarkers = [];
		}
		function clearAll() {
			clearStations();
			clearDirections();
			hideCompleteRoute();
			clearBuses();
		}
		
		function parseBuses(text) {
			info = JSON.parse(text);
			addBuses(info);
		}
		
		function hideCompleteRoute() {
			for(i=0;i<completeRoute.length;i++) {
				completeRoute[i].setMap(null);
			}
			completeRoute = [];
		}
		function showCompleteRoute() {
			hideCompleteRoute();
			addDirections(true);
		}
		
		function addBuses(buses) {
			for(i=0;i<buses.length;i++) {
				var image = {
					url:'http://www.theedgeproperty.com.sg/sites/all/modules/analytic/images/icons/bus.png',
					//url:'http://www.nyfalls.com/assets/maps/icons/transportation-blue/busstop.png'
					//size: new google.maps.Size(100, 100),
				};
				
				var marker = new google.maps.Marker({
					position: {lat: parseFloat(buses[i].latitude), lng: parseFloat(buses[i].longitude)},
					//label: labels[i % labels.length],
					map: map,
					icon: image,
					load: buses[i].load,
					code: buses[i].code,
					max: buses[i].max_capacity,
					myid: buses[i].id,
				});
				console.log(buses[i]);
				google.maps.event.addListener(marker, "click", function(event) { {# https://developers.google.com/maps/articles/phpsqlinfo_v3 #}
					// ?????????????????
					showBusControls(this);
					//showStationControls(this.myid);
				});
				busMarkers.push(marker);
			}
		}
		function parseText(text) {
			clearAll();
			//info = JSON.parse(text);
			
			//addStations(info.stations);
			addStations(text);
			
			addDirections(true);
			addDirections(false);
		}
		function addStations(stations) {
			var bounds = new google.maps.LatLngBounds(); {# http://stackoverflow.com/questions/1556921/google-map-api-v3-set-bounds-and-center?noredirect=1&lq=1 #}
			
			for(i=0;i<stations.length;i++) {
				console.log(stations[i]);
				
				var image = {
					//url:'http://www.theedgeproperty.com.sg/sites/all/modules/analytic/images/icons/bus.png',
					url:'http://www.nyfalls.com/assets/maps/icons/transportation-blue/busstop.png'
					//size: new google.maps.Size(100, 100),
				};
				
				var marker = new google.maps.Marker({
					position: {lat: parseFloat(stations[i].station.latitude), lng: parseFloat(stations[i].station.longitude)},
					//label: labels[i % labels.length],
					map: map,
					icon: image,
					code: stations[i].station.code,
					myid: stations[i].station.id,
					goto: 1
				});
				bounds.extend(marker.position);
				google.maps.event.addListener(marker, "click", function(event) { {# https://developers.google.com/maps/articles/phpsqlinfo_v3 #}
					//console.log(stations.stations[i].id);
					//console.log(this.position.lat() + " - " + this.position.lng()); {# http://stackoverflow.com/questions/6374329/get-latitude-and-longitude-of-marker-onclick #}
					//console.log(this.myid);
					showStationControls(this);
				});
				
				stationMarkers.push(marker);
			}
			map.fitBounds(bounds);
		}
		function showStationControls(station) {
			$(".item-title").text("Station "+station.code);
			$(".bus-control").hide();
			$(".station-control").show();
			currentBus = null;
			currentStation = station.myid;
		}
		function showBusControls(bus) {
			$(".item-title").text("Bus " + bus.code);
			$(".bus-control").show();
			$(".station-control").hide();
			currentStation = null;
			currentBus = bus.code;
		}
		
		function addDirections(all) {
			var tmpStations = [];
			for(i=0; i<stationMarkers.length; i++) {
				var sm = stationMarkers[i];
				if(true || all) { // sm.myid != 2 ||
					tmpStations.push(sm);
				}
			}
			
			for(i=0; i<tmpStations.length - 1 ; i++) {
				var sm = tmpStations[i];
				var next = tmpStations[i+1];
				var travelMode = google.maps.DirectionsTravelMode.DRIVING;  
				var request = {
					origin: sm.position,
					destination: next.position,
					travelMode: travelMode
				};  
				var rendererOptions = {
					map: map,
					suppressMarkers : true,
					preserveViewport: true
				}
				if(all) {
					rendererOptions.polylineOptions = {strokeColor: "#111", strokeOpacity: 0.3, strokeWeight:5};
				}
				directionsService.route(request, function(response, status) {
					disp = new google.maps.DirectionsRenderer(rendererOptions);     
					disp.setMap(map);
					disp.setDirections(response);
					if (all) {
						completeRoute.push(disp);
					}else {
						routeDirections.push(disp);
					}
				});
			}
		}
		
		function parseLines(text) {
			//var tmp = JSON.parse(text);
			var tmp = text;
			for(i=0;i<tmp.length;i++) {
				var line = tmp[i];
				$(".lines").append("<li><a class='line' href='javascript:void(0)' data-id='" + line.id + "' data-linenumber='" + line.number + "' >" + line.number + "</a></li>");
			}
			
			$(".line").on("click", function() {
				$(".line-title").text($(this).data('linenumber') + " line");
				$(".line-control").show();
				
				$("#btn-show-complete").hide();
				$("#btn-hide-complete").show();
				
				$.get( "http://junction.westeurope.cloudapp.azure.com/api/line/" + $(this).data("id") + "/?format=json", function( data ) {
					//parseLines(data);
					parseText(data.stops);
					addBuses(data.buses);
				});
				
				//alert($(this).data("linenumber"));
				//parseText(stationsText);
				//parseBuses(buss);
			});
		}
		
		function getBusById(id) {
			//return busMarkers[0];
			for (i=0; i<busMarkers.length; i++) {
				if(busMarkers[i].myid == id) return busMarkers[i];
			}
			return;
		}
		function getStationById(id) {
			//return busMarkers[0];
			for (i=0; i<stationMarkers.length; i++) {
				if(stationMarkers[i].myid == id) return stationMarkers[i];
			}
			return;
		}
		
		// ---------------------------------------------------
		
		var stationsText = '{ "stations" : [' +
		'{ "name":"Solvik" , "lat":60.1680265 , "lng":24.9375109, "id":1 },' + //60.1680265,24.9375109 //ORIGINAL-60.201517-24.375928
		'{ "name":"Louhosmäki" , "lat":60.165650 , "lng":24.936524, "id":2 },' + //60.165650, 24.936524 //ORIGINAL-60.202282-24.358088
		'{ "name":"Evitskog" , "lat":60.1649276 , "lng":24.9288585, "id":3},' + //60.1649276,24.9288585 //ORIGINAL-60.20141-24.342
		'{ "name":"", "lat":60.1619962, "lng":24.9289412, "id":4}]}'; 
		
		var lines = '[{"name":"Lijn 14"},{"name":"Lijn 17"}]';
		
		var buss = '[{"id":10,"lat":60.168067,"lng":24.934156},{"id":20,"lat":60.165238,"lng":24.929650},{"id":30,"lat":60.163039,"lng":24.928191}]';
		
		
		$(".line-control").hide();
		$(".station-control").hide();
		$(".bus-control").hide();
		$("#btn-show-complete").hide();
		
		
		$("#btn-show-complete").on("click", function() {
			showCompleteRoute();
			$("#btn-show-complete").hide();
			$("#btn-hide-complete").show();		
		});
		$("#btn-hide-complete").on("click", function() {
			hideCompleteRoute();
			$("#btn-show-complete").show();
			$("#btn-hide-complete").hide();
		});
		
		$("#bus-load").slider();
		$("#bus-load").on("slideStop", function(event) {
			console.log(event.value);
			if(event.value[1] < event.value[0]) { //max is less than min
				$("#bus-load").slider('setValue', [event.value[0], event.value[0]]);
			}
			if(event.value[0] > event.value[1]) { //min is greater than max
				$("#bus-load").slider('setValue', [event.value[1], event.value[1]]);
			}
		});
	</script>
	<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUhVDH00C242tqOr9-NI2jIyQEqcl4ZWo&callback=initMap">
	</script>
	<script src="js/moment.js" ></script>
	<script src="js/moment-with-locales.js" ></script>
	<script src="js/transition.js" ></script>
	<script src="js/collapse.js" ></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<script src="js/bootstrap-datetimepicker.min.js" ></script>
	
  </body>
</html>
